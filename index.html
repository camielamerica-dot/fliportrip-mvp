<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOrTrip | Swipe & Match v0.48</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;800&display=swap" rel="stylesheet">
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --mint: #00FFC2; --obsidian: #0B0E14; --card-bg: #161B22; --text-muted: #8899A6; }
        body { background: var(--obsidian); color: white; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; }
        
        .screen { display: none; height: 100vh; padding: 25px; box-sizing: border-box; flex-direction: column; }
        .screen.active { display: flex; }

        .logo { width: 140px; margin: 40px auto; display: block; }
        .card-bg { background: var(--card-bg); padding: 25px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-main { background: var(--mint); color: var(--obsidian); border: none; padding: 20px; border-radius: 50px; font-weight: 800; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: 15px; }
        input { background: #0B0E14; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 18px; border-radius: 20px; width: 100%; box-sizing: border-box; margin-bottom: 12px; font-family: inherit; text-align: center; font-size: 16px; }

        .deck { position: relative; flex: 1; margin: 20px 0; perspective: 1000px; }
        .swipe-card { position: absolute; width: 100%; height: 100%; border-radius: 35px; overflow: hidden; background: var(--card-bg); box-shadow: 0 15px 40px rgba(0,0,0,0.6); transform-origin: 50% 100%; touch-action: none; }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 35px; background: linear-gradient(transparent, rgba(0,0,0,1)); }
        
        .match-overlay { position: fixed; inset: 0; background: rgba(0,255,194,0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--obsidian); text-align: center; padding: 40px; }

        .controls { display: flex; justify-content: center; gap: 25px; padding-bottom: 30px; }
        .round-btn { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; }
        .btn-no { background: #161B22; color: #FF4B4B; border: 2px solid #FF4B4B; }
        .btn-yes { background: var(--mint); color: var(--obsidian); }
    </style>
</head>
<body>

    <div id="match-notif" class="match-overlay">
        <h1 style="font-size: 50px; margin: 0;">MATCH! ðŸ”¥</h1>
        <p id="match-name" style="font-size: 20px; font-weight: 800; margin: 20px 0 40px;"></p>
        <button class="btn-main" onclick="closeMatch()">Verder swipen</button>
    </div>

    <div id="screen-start" class="screen active">
        <img src="https://wijzijnvalkenburg.nl/wp-content/uploads/2026/02/fliportrip_logo.png" class="logo">
        <div class="card-bg">
            <h2 style="text-align: center; margin-top: 0;">Samen op pad?</h2>
            <button class="btn-main" onclick="initCreateRoom()">Maak nieuwe room</button>
            <div style="margin: 25px 0; text-align: center; font-size: 11px; color: var(--text-muted); font-weight: 800; letter-spacing: 1px;">OF JOIN JE VRIENDEN</div>
            <input type="text" id="join-input" placeholder="CODE">
            <button class="btn-main" style="background:transparent; border:1px solid var(--mint); color:white;" onclick="joinRoom()">Join Room</button>
        </div>
    </div>

    <div id="screen-swipe" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:12px; font-weight: 800; color: var(--text-muted);">
            <span>ROOM: <span id="r-code" style="color:var(--mint);"></span></span>
            <span id="card-count"></span>
        </div>
        <div class="deck" id="main-deck"></div>
        <div class="controls">
            <button class="round-btn btn-no" onclick="manualBtn('left')">âœ•</button>
            <button class="round-btn btn-yes" onclick="manualBtn('right')">â™¥</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <h2 style="text-align:center;">Jullie Plan ðŸ”¥</h2>
        <div id="match-list" style="flex:1; overflow-y:auto; padding-bottom:20px;"></div>
        <div class="card-bg">
            <input type="email" id="email-to" placeholder="Je e-mailadres">
            <button class="btn-main" onclick="sendMail()">Stuur plan naar mail</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, updateDoc, arrayUnion, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAx_XDqOW9hth7dwSFBZYJnk_dTa2lnvQ0",
            authDomain: "fliportrip-valkenburg.firebaseapp.com",
            projectId: "fliportrip-valkenburg",
            storageBucket: "fliportrip-valkenburg.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        emailjs.init("VlUuJ7R9pE7W7XwVq");

        let roomId = '';
        let acts = [];
        let currentMatches = [];

        window.showS = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        window.initCreateRoom = async () => {
            roomId = Math.random().toString(36).substring(2,6).toUpperCase();
            await setDoc(doc(db, "rooms", roomId), { likes: [], matches: [], created: new Date() });
            startSwiping();
        };

        window.joinRoom = async () => {
            const code = document.getElementById('join-input').value.toUpperCase();
            const snap = await getDoc(doc(db, "rooms", code));
            if(snap.exists()) { roomId = code; startSwiping(); }
            else alert("Code niet gevonden!");
        };

        async function startSwiping() {
            document.getElementById('r-code').innerText = roomId;
            const snap = await getDocs(collection(db, "activities"));
            acts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCards();
            listenMatches();
            showS('screen-swipe');
        }

        function renderCards() {
            const container = document.getElementById('main-deck');
            container.innerHTML = '';
            document.getElementById('card-count').innerText = acts.length + " ITEMS";
            acts.forEach((a, i) => {
                const card = document.createElement('div');
                card.className = 'swipe-card';
                card.style.zIndex = acts.length - i;
                card.innerHTML = `<img src="${a.image}"><div class="card-info">
                    <span style="color:var(--mint);font-size:10px;font-weight:800;text-transform:uppercase;">${a.price || 'â‚¬â‚¬'}</span>
                    <h2 style="margin:5px 0 0;">${a.title}</h2>
                </div>`;
                container.appendChild(card);
                if(i === 0) bindHammer(card, a);
            });
        }

        function bindHammer(el, activity) {
            const mc = new Hammer(el);
            mc.on('pan', e => el.style.transform = `translate(${e.deltaX}px, ${e.deltaY}px) rotate(${e.deltaX/20}deg)`);
            mc.on('panend', e => {
                if(e.deltaX > 140) handleAction(activity, 'right');
                else if(e.deltaX < -140) handleAction(activity, 'left');
                else { el.style.transition = '0.3s'; el.style.transform = ''; }
            });
        }

        async function handleAction(a, dir) {
            const card = document.querySelector('.swipe-card');
            if(!card) return;
            card.style.transition = '0.5s';
            card.style.transform = dir === 'right' ? 'translateX(200%) rotate(30deg)' : 'translateX(-200%) rotate(-30deg)';
            
            // ANALYTICS VOOR DASHBOARD (Geruisloos)
            addDoc(collection(db, "global_analytics"), {
                activityTitle: a.title,
                action: dir === 'right' ? 'like' : 'dislike',
                timestamp: new Date()
            });

            // ROOM LOGIC
            if(dir === 'right') {
                const roomRef = doc(db, "rooms", roomId);
                const roomSnap = await getDoc(roomRef);
                const likes = roomSnap.data().likes || [];
                if(likes.includes(a.title)) updateDoc(roomRef, { matches: arrayUnion(a.title) });
                else updateDoc(roomRef, { likes: arrayUnion(a.title) });
            }

            setTimeout(() => {
                card.remove();
                acts.shift();
                if(acts.length > 0) renderCards();
                else showS('screen-results');
            }, 300);
        }

        function listenMatches() {
            onSnapshot(doc(db, "rooms", roomId), (s) => {
                const m = s.data().matches || [];
                if(m.length > currentMatches.length) {
                    document.getElementById('match-name').innerText = m[m.length-1];
                    document.getElementById('match-notif').style.display = 'flex';
                }
                currentMatches = m;
                document.getElementById('match-list').innerHTML = m.map(title => `
                    <div class="card-bg" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-weight:800;">${title}</span>
                        <button class="btn-main" style="width:auto; margin:0; padding:10px 20px;" onclick="window.open('https://google.com/search?q=${title}+Valkenburg')">Info</button>
                    </div>
                `).join('');
            });
        }

        window.closeMatch = () => document.getElementById('match-notif').style.display = 'none';
        window.manualBtn = (dir) => handleAction(acts[0], dir);
        window.sendMail = () => {
            const email = document.getElementById('email-to').value;
            emailjs.send("service_xsnq464", "template_4276tqc", {
                to_email: email, room_code: roomId, matches: currentMatches.join(", ")
            }).then(() => alert("Plan verzonden!"));
        };
    </script>
</body>
</html>
