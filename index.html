<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOrTrip | Ontdek Valkenburg</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;800&display=swap" rel="stylesheet">
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --mint: #00FFC2; --obsidian: #0B0E14; --card-bg: #161B22; --text-muted: #8899A6; }
        body { background: var(--obsidian); color: white; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; }
        
        .screen { display: none; height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; justify-content: center; }
        .screen.active { display: flex; }

        /* UI Elements */
        .logo { width: 120px; margin: 0 auto 30px; display: block; }
        .card-bg { background: var(--card-bg); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-main { background: var(--mint); color: var(--obsidian); border: none; padding: 18px; border-radius: 50px; font-weight: 800; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: 15px; }
        input { background: #0B0E14; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; text-align: center; }

        /* Grid Selection */
        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .opt-btn { background: var(--card-bg); border: 2px solid transparent; padding: 15px; border-radius: 15px; color: white; cursor: pointer; text-align: center; font-size: 13px; font-weight: 800; transition: 0.2s; }
        .opt-btn.selected { border-color: var(--mint); background: rgba(0,255,194,0.1); color: var(--mint); }

        /* Swipe Deck */
        .deck-container { position: relative; width: 100%; height: 65vh; perspective: 1000px; margin-top: 20px; }
        .swipe-card { position: absolute; width: 100%; height: 100%; border-radius: 30px; overflow: hidden; background: var(--card-bg); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform-origin: 50% 100%; touch-action: none; }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 25px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); }

        .controls { display: flex; justify-content: center; gap: 20px; margin-top: 25px; }
        .round-btn { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .btn-no { background: #161B22; color: #FF4B4B; border: 2px solid #FF4B4B; }
        .btn-yes { background: var(--mint); color: var(--obsidian); }

        #room-code-display { letter-spacing: 5px; color: var(--mint); font-size: 24px; font-weight: 800; }
    </style>
</head>
<body>

    <div id="screen-welcome" class="screen active">
        <img src="https://wijzijnvalkenburg.nl/wp-content/uploads/2026/02/fliportrip_logo.png" class="logo">
        <div class="card-bg" style="text-align: center;">
            <h2 style="margin-top:0;">Samen ontdekken?</h2>
            <button class="btn-main" onclick="initCreateRoom()">Maak nieuwe room</button>
            <p style="margin: 20px 0 10px; color: var(--text-muted); font-size: 12px;">OF JOIN EEN CODE</p>
            <input type="text" id="join-input" placeholder="CODE">
            <button class="btn-main" style="background: transparent; color: white; border: 1px solid var(--mint);" onclick="joinRoom()">Join Room</button>
        </div>
    </div>

    <div id="screen-onboarding" class="screen">
        <h2 style="text-align:center;">Wie ben je?</h2>
        <div class="card-bg">
            <span style="font-size:10px; color:var(--mint); font-weight:800; text-transform:uppercase;">Leeftijd</span>
            <div class="opt-grid">
                <div class="opt-btn" onclick="selectProfile('age', '18-24', this)">18-24</div>
                <div class="opt-btn" onclick="selectProfile('age', '25-34', this)">25-34</div>
                <div class="opt-btn" onclick="selectProfile('age', '35-50', this)">35-50</div>
                <div class="opt-btn" onclick="selectProfile('age', '50+', this)">50+</div>
            </div>
            <span style="font-size:10px; color:var(--mint); font-weight:800; text-transform:uppercase;">Gezelschap</span>
            <div class="opt-grid">
                <div class="opt-btn" onclick="selectProfile('tripType', 'Partner', this)">Partner</div>
                <div class="opt-btn" onclick="selectProfile('tripType', 'Vrienden', this)">Vrienden</div>
                <div class="opt-btn" onclick="selectProfile('tripType', 'Gezin', this)">Gezin</div>
                <div class="opt-btn" onclick="selectProfile('tripType', 'Solo', this)">Solo</div>
            </div>
            <button class="btn-main" onclick="startSwiping()">Start Swiping</button>
        </div>
    </div>

    <div id="screen-swipe" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span style="font-size:12px; font-weight:800;">ROOM: <span id="room-code-display"></span></span>
            <div id="match-notif" style="color:var(--mint); font-weight:800; font-size:12px; display:none;">MATCH! ðŸ”¥</div>
        </div>
        <div class="deck-container" id="deck"></div>
        <div class="controls">
            <button class="round-btn btn-no" onclick="manualSwipe('left')">âœ•</button>
            <button class="round-btn btn-yes" onclick="manualSwipe('right')">â™¥</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <h2 style="text-align:center;">Jullie Matches! ðŸ”¥</h2>
        <div id="matches-list" style="flex:1; overflow-y:auto; margin-bottom:20px;"></div>
        <div class="card-bg">
            <input type="email" id="user-email" placeholder="Je e-mailadres">
            <button class="btn-main" onclick="sendMatchEmail()">Stuur plan naar mail</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAx_XDqOW9hth7dwSFBZYJnk_dTa2lnvQ0",
            authDomain: "fliportrip-valkenburg.firebaseapp.com",
            projectId: "fliportrip-valkenburg",
            storageBucket: "fliportrip-valkenburg.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        emailjs.init("VlUuJ7R9pE7W7XwVq");

        let currentRoomId = '';
        let activities = [];
        let profile = { age: '', tripType: '' };
        let matchedTitles = [];

        // NAVIGATION
        window.showScreen = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        };

        // ROOM LOGIC
        window.initCreateRoom = async () => {
            const code = Math.random().toString(36).substring(2,6).toUpperCase();
            currentRoomId = code;
            await setDoc(doc(db, "rooms", code), { 
                createdAt: new Date(), 
                likes: [],
                matches: [] 
            });
            showScreen('screen-onboarding');
        };

        window.joinRoom = async () => {
            const code = document.getElementById('join-input').value.toUpperCase();
            const snap = await getDoc(doc(db, "rooms", code));
            if(snap.exists()) {
                currentRoomId = code;
                showScreen('screen-onboarding');
            } else alert("Code niet gevonden");
        };

        // PROFILE
        window.selectProfile = (key, val, el) => {
            el.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            profile[key] = val;
        };

        // START SWIPING
        window.startSwiping = async () => {
            document.getElementById('room-code-display').innerText = currentRoomId;
            const snap = await getDocs(collection(db, "activities"));
            activities = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderDeck();
            listenToMatches();
            showScreen('screen-swipe');
        };

        function renderDeck() {
            const deck = document.getElementById('deck');
            deck.innerHTML = '';
            activities.forEach((act, i) => {
                const card = document.createElement('div');
                card.className = 'swipe-card';
                card.style.zIndex = activities.length - i;
                card.innerHTML = `
                    <img src="${act.image}">
                    <div class="card-info">
                        <span style="color:var(--mint); font-weight:800; font-size:10px;">${act.price || 'â‚¬â‚¬'}</span>
                        <h2 style="margin:5px 0 0;">${act.title}</h2>
                    </div>
                `;
                deck.appendChild(card);
                if(i === 0) setupSwipe(card, act);
            });
        }

        function setupSwipe(el, activity) {
            const hammer = new Hammer(el);
            hammer.on('pan', (e) => {
                el.style.transform = `translate(${e.deltaX}px, ${e.deltaY}px) rotate(${e.deltaX/20}deg)`;
            });
            hammer.on('panend', async (e) => {
                if (e.deltaX > 120) handleDecision(activity, 'right');
                else if (e.deltaX < -120) handleDecision(activity, 'left');
                else el.style.transform = '';
            });
        }

        async function handleDecision(activity, dir) {
            const card = document.querySelector('.swipe-card');
            card.style.transition = '0.5s';
            card.style.transform = dir === 'right' ? 'translateX(200%) rotate(30deg)' : 'translateX(-200%) rotate(-30deg)';
            
            // ANALYTICS VOOR DASHBOARD
            await addDoc(collection(db, "global_analytics"), {
                activityTitle: activity.title,
                action: dir === 'right' ? 'like' : 'dislike',
                userAge: profile.age,
                tripType: profile.tripType,
                timestamp: new Date()
            });

            // ROOM SYNC VOOR MATCHES
            if(dir === 'right') {
                const roomRef = doc(db, "rooms", currentRoomId);
                const snap = await getDoc(roomRef);
                const currentLikes = snap.data().likes || [];
                
                if(currentLikes.includes(activity.title)) {
                    await updateDoc(roomRef, { matches: arrayUnion(activity.title) });
                } else {
                    await updateDoc(roomRef, { likes: arrayUnion(activity.title) });
                }
            }

            setTimeout(() => {
                card.remove();
                activities.shift();
                if(activities.length > 0) renderDeck();
                else showScreen('screen-results');
            }, 300);
        }

        function listenToMatches() {
            onSnapshot(doc(db, "rooms", currentRoomId), (doc) => {
                const matches = doc.data().matches || [];
                if(matches.length > matchedTitles.length) {
                    document.getElementById('match-notif').style.display = 'block';
                    setTimeout(() => document.getElementById('match-notif').style.display = 'none', 2000);
                }
                matchedTitles = matches;
                renderMatches(matches);
            });
        }

        function renderMatches(matches) {
            const container = document.getElementById('matches-list');
            container.innerHTML = matches.map(m => `
                <div class="card-bg" style="margin-bottom:10px; display:flex; align-items:center; gap:15px;">
                    <div style="flex:1;"><strong>${m}</strong></div>
                    <button class="btn-main" style="width:auto; padding:8px 15px; margin:0;" onclick="window.open('https://google.com/search?q=${m}+Valkenburg')">Info</button>
                </div>
            `).join('');
        }

        window.sendMatchEmail = async () => {
            const email = document.getElementById('user-email').value;
            if(!email) return alert("E-mail verplicht");
            
            const params = {
                to_email: email,
                room_code: currentRoomId,
                matches: matchedTitles.join(", ")
            };

            emailjs.send("service_xsnq464", "template_4276tqc", params)
                .then(() => alert("Plan verstuurd! Veel plezier!"))
                .catch(() => alert("Fout bij versturen."));
        };

        window.manualSwipe = (dir) => {
            if(activities.length > 0) handleDecision(activities[0], dir);
        };
    </script>
</body>
</html>
