<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlipOrTrip | Swipe & Match</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;800&display=swap" rel="stylesheet">
    <script src="https://hammerjs.github.io/dist/hammer.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root { --mint: #00FFC2; --obsidian: #0B0E14; --card-bg: #161B22; --text-muted: #8899A6; }
        body { background: var(--obsidian); color: white; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; overflow: hidden; }
        
        .screen { display: none; height: 100vh; padding: 20px; box-sizing: border-box; flex-direction: column; }
        .screen.active { display: flex; }

        /* Welcome & Onboarding */
        .logo { width: 120px; margin: 40px auto; display: block; }
        .card-bg { background: var(--card-bg); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.05); }
        .btn-main { background: var(--mint); color: var(--obsidian); border: none; padding: 18px; border-radius: 50px; font-weight: 800; width: 100%; cursor: pointer; text-transform: uppercase; font-size: 14px; margin-top: 15px; }
        input { background: #0B0E14; border: 1px solid rgba(255,255,255,0.1); color: white; padding: 15px; border-radius: 15px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: inherit; text-align: center; font-size: 16px; }

        .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .opt-btn { background: var(--card-bg); border: 2px solid transparent; padding: 15px; border-radius: 15px; color: white; cursor: pointer; text-align: center; font-size: 12px; font-weight: 800; }
        .opt-btn.selected { border-color: var(--mint); background: rgba(0,255,194,0.1); color: var(--mint); }

        /* Swipe UI */
        .deck-container { position: relative; flex: 1; margin: 20px 0; perspective: 1000px; }
        .swipe-card { position: absolute; width: 100%; height: 100%; border-radius: 30px; overflow: hidden; background: var(--card-bg); box-shadow: 0 10px 30px rgba(0,0,0,0.5); transform-origin: 50% 100%; }
        .swipe-card img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; }
        .card-info { position: absolute; bottom: 0; left: 0; right: 0; padding: 30px; background: linear-gradient(transparent, rgba(0,0,0,1)); }
        
        .match-overlay { position: fixed; inset: 0; background: rgba(0,255,194,0.9); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; color: var(--obsidian); }

        .controls { display: flex; justify-content: center; gap: 20px; padding-bottom: 20px; }
        .round-btn { width: 65px; height: 65px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; }
        .btn-no { background: #161B22; color: #FF4B4B; border: 2px solid #FF4B4B; }
        .btn-yes { background: var(--mint); color: var(--obsidian); }

        /* Header Info */
        .header-bar { display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: 800; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
    </style>
</head>
<body>

    <div id="match-notif" class="match-overlay">
        <h1 style="font-size: 60px; margin: 0;">MATCH!</h1>
        <p id="match-name" style="font-weight: 800;"></p>
        <button class="btn-main" style="width: 200px;" onclick="closeMatch()">Doorgaan</button>
    </div>

    <div id="screen-welcome" class="screen active">
        <img src="https://wijzijnvalkenburg.nl/wp-content/uploads/2026/02/fliportrip_logo.png" class="logo">
        <div class="card-bg">
            <h2 style="text-align: center; margin-top: 0;">Valkenburg Ontdekken</h2>
            <button class="btn-main" onclick="createRoom()">Nieuwe Groep</button>
            <div style="margin: 20px 0; text-align: center; font-size: 12px; color: var(--text-muted);">OF JOIN EEN CODE</div>
            <input type="text" id="join-code" placeholder="CODE">
            <button class="btn-main" style="background:transparent; border:1px solid var(--mint); color:white;" onclick="joinRoom()">Join Room</button>
        </div>
    </div>

    <div id="screen-onboarding" class="screen">
        <div class="header-bar"><span>Stap 1/2</span><span id="display-code"></span></div>
        <h2 style="margin: 20px 0;">Stel je profiel in</h2>
        <div class="card-bg">
            <span style="font-size: 10px; color: var(--mint); font-weight: 800;">LEEFTIJD</span>
            <div class="opt-grid">
                <div class="opt-btn" onclick="setProfile('age', '18-24', this)">18-24</div>
                <div class="opt-btn" onclick="setProfile('age', '25-34', this)">25-34</div>
                <div class="opt-btn" onclick="setProfile('age', '35-50', this)">35-50</div>
                <div class="opt-btn" onclick="setProfile('age', '50+', this)">50+</div>
            </div>
            <span style="font-size: 10px; color: var(--mint); font-weight: 800;">GEZELSCHAP</span>
            <div class="opt-grid">
                <div class="opt-btn" onclick="setProfile('tripType', 'Partner', this)">Partner</div>
                <div class="opt-btn" onclick="setProfile('tripType', 'Vrienden', this)">Vrienden</div>
                <div class="opt-btn" onclick="setProfile('tripType', 'Gezin', this)">Gezin</div>
                <div class="opt-btn" onclick="setProfile('tripType', 'Solo', this)">Solo</div>
            </div>
            <button class="btn-main" onclick="initSwipe()">Bekijk Activiteiten</button>
        </div>
    </div>

    <div id="screen-swipe" class="screen">
        <div class="header-bar"><span id="room-id">ROOM</span><span>Swipe naar rechts voor Like</span></div>
        <div class="deck-container" id="deck"></div>
        <div class="controls">
            <button class="round-btn btn-no" onclick="manualAction('left')">âœ•</button>
            <button class="round-btn btn-yes" onclick="manualAction('right')">â™¥</button>
        </div>
    </div>

    <div id="screen-results" class="screen">
        <h2 style="text-align: center;">Jullie Plan ðŸ”¥</h2>
        <div id="matches-list" style="flex: 1; overflow-y: auto;"></div>
        <div class="card-bg" style="margin-top: 20px;">
            <input type="email" id="email-input" placeholder="Je e-mail">
            <button class="btn-main" onclick="sendPlan()">Mail Plan</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, updateDoc, arrayUnion, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAx_XDqOW9hth7dwSFBZYJnk_dTa2lnvQ0",
            authDomain: "fliportrip-valkenburg.firebaseapp.com",
            projectId: "fliportrip-valkenburg",
            storageBucket: "fliportrip-valkenburg.firebasestorage.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        emailjs.init("VlUuJ7R9pE7W7XwVq");

        let roomId = '';
        let acts = [];
        let profile = { age: '', tripType: '' };
        let matchedSoFar = [];

        window.show = (s) => {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(s).classList.add('active');
        };

        window.createRoom = async () => {
            roomId = Math.random().toString(36).substring(2,6).toUpperCase();
            await setDoc(doc(db, "rooms", roomId), { likes: [], matches: [], created: new Date() });
            document.getElementById('display-code').innerText = "CODE: " + roomId;
            show('screen-onboarding');
        };

        window.joinRoom = async () => {
            const code = document.getElementById('join-code').value.toUpperCase();
            const s = await getDoc(doc(db, "rooms", code));
            if(s.exists()) { roomId = code; show('screen-onboarding'); }
            else alert("Niet gevonden");
        };

        window.setProfile = (k, v, el) => {
            el.parentElement.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
            profile[k] = v;
        };

        window.initSwipe = async () => {
            const s = await getDocs(collection(db, "activities"));
            acts = s.docs.map(d => ({ id: d.id, ...d.data() }));
            document.getElementById('room-id').innerText = "ROOM: " + roomId;
            renderDeck();
            listen();
            show('screen-swipe');
        };

        function renderDeck() {
            const d = document.getElementById('deck'); d.innerHTML = '';
            acts.forEach((a, i) => {
                const c = document.createElement('div');
                c.className = 'swipe-card';
                c.style.zIndex = acts.length - i;
                c.innerHTML = `<img src="${a.image}"><div class="card-info">
                    <span style="color:var(--mint);font-size:10px;font-weight:800;">${a.price}</span>
                    <h2 style="margin:5px 0 0;">${a.title}</h2>
                </div>`;
                d.appendChild(c);
                if(i === 0) bind(c, a);
            });
        }

        function bind(el, a) {
            const h = new Hammer(el);
            h.on('pan', e => el.style.transform = `translate(${e.deltaX}px, ${e.deltaY}px) rotate(${e.deltaX/20}deg)`);
            h.on('panend', e => {
                if(e.deltaX > 120) act(a, 'right');
                else if(e.deltaX < -120) act(a, 'left');
                else el.style.transform = '';
            });
        }

        async function act(a, dir) {
            const c = document.querySelector('.swipe-card');
            c.style.transition = '0.4s';
            c.style.transform = dir === 'right' ? 'translateX(200%) rotate(30deg)' : 'translateX(-200%) rotate(-30deg)';
            
            // MANAGEMENT DASHBOARD SYNC
            addDoc(collection(db, "global_analytics"), {
                activityTitle: a.title,
                action: dir === 'right' ? 'like' : 'dislike',
                userAge: profile.age,
                tripType: profile.tripType,
                timestamp: new Date()
            });

            // ROOM SYNC
            if(dir === 'right') {
                const r = doc(db, "rooms", roomId);
                const snap = await getDoc(r);
                const l = snap.data().likes || [];
                if(l.includes(a.title)) updateDoc(r, { matches: arrayUnion(a.title) });
                else updateDoc(r, { likes: arrayUnion(a.title) });
            }

            setTimeout(() => {
                c.remove(); acts.shift();
                if(acts.length > 0) renderDeck();
                else show('screen-results');
            }, 300);
        }

        function listen() {
            onSnapshot(doc(db, "rooms", roomId), (s) => {
                const m = s.data().matches || [];
                if(m.length > matchedSoFar.length) {
                    document.getElementById('match-name').innerText = m[m.length-1];
                    document.getElementById('match-notif').style.display = 'flex';
                }
                matchedSoFar = m;
                document.getElementById('matches-list').innerHTML = m.map(item => `
                    <div class="card-bg" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span>${item}</span>
                        <button class="btn-main" style="width:auto; margin:0; padding:8px 15px;" onclick="window.open('https://google.com/search?q=${item}+Valkenburg')">Google</button>
                    </div>
                `).join('');
            });
        }

        window.closeMatch = () => document.getElementById('match-notif').style.display = 'none';
        window.manualAction = (d) => act(acts[0], d);

        window.sendPlan = () => {
            const e = document.getElementById('email-input').value;
            emailjs.send("service_xsnq464", "template_4276tqc", {
                to_email: e, room_code: roomId, matches: matchedSoFar.join(", ")
            }).then(() => alert("Plan verzonden!"));
        };
    </script>
</body>
</html>
